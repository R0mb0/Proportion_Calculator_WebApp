<!DOCTYPE html>
<html lang="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Proportion Calculator</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,700,900&display=swap"/>
  <style>
    :root {
      --color-bg-light: #f6f7fa;
      --color-bg-dark: #181a1b;
      --color-card-light: #fff;
      --color-card-dark: #26282b;
      --color-primary: #27c46b;
      --color-error: #e94747;
      --color-accent: #ffa437;
      --color-shadow: rgba(60, 60, 60, .07);
      --color-result: #27c46b;
      --radius-lg: 22px;
      --radius-md: 15px;
      --radius-sm: 8px;
      font-family: Inter, Roboto, Arial, sans-serif;
    }
    body {
      margin: 0;
      background: var(--color-bg-light);
      color: #22293a;
      min-height:100vh;
      font-family: Inter, Roboto, Arial, sans-serif;
      position: relative;
    }
    body.dark {
      background: var(--color-bg-dark);
      color: #ebeded;
    }
    .container {
      max-width: 840px;
      margin: 40px auto;
      padding: 0 12px;
      width: 100vw;
      box-sizing: border-box;
    }
    .title {
      text-align: center;
      font-size: 2.3rem;
      font-weight: 900;
      margin-bottom: 40px;
      letter-spacing: 0.01em;
      background: linear-gradient(90deg, #27c46b 10%, #ffa437 70%, #27c46b 100%);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 3px 16px rgba(39,196,107,0.18), 0 2px 0 #232;
      animation: gradientMove 2.6s ease-in-out infinite alternate;
      user-select: none;
    }
    @keyframes gradientMove {
      0% {background-position: 0% 50%;}
      100% {background-position: 100% 50%;}
    }
    .proportion-row {
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 0;
      width: 100%;
      margin-bottom: 34px;
      flex-wrap: nowrap;
      min-width: 0;
    }
    .block {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1 1 0%;
      min-width: 0;
      margin: 0 6px;
      position: relative;
      box-sizing: border-box;
    }
    .block .label {
      font-size: 1.01rem;
      font-weight: 600;
      margin-bottom: 2px;
      color: #757575;
      letter-spacing: 0.02em;
      transition: color .2s;
      user-select: none;
      text-align: center;
      white-space: nowrap;
      width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.dark .block .label { color: #bccad8; }
    .input-box {
      border: 2.2px solid #d1d6de;
      background: var(--color-card-light);
      border-radius: var(--radius-lg);
      font-size: 1.13rem;
      text-align: center;
      width: 100%;
      min-width: 48px;
      max-width: 190px;
      padding: 14px 10px;
      outline: none;
      transition: border-color .22s, box-shadow .15s;
      box-shadow: 0 1px 10px var(--color-shadow);
      font-family: inherit;
      color: inherit;
      font-weight: 500;
      box-sizing: border-box;
    }
    body.dark .input-box {
      background: var(--color-card-dark);
      border-color: #393d46;
      color: #ebeded;
      box-shadow: 0 2px 18px rgba(0,0,0,.09);
    }
    .input-box.result {
      border-color: var(--color-result)!important;
      box-shadow: 0 0 0 2px var(--color-result), 0 2px 18px rgba(39,196,107,.16);
    }
    .sep {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.7rem; 
      font-weight: 700;
      color: #aaa;
      margin-bottom: 36px;
      margin-left: -2px;
      margin-right: -2px;
      min-width: 25px; width:25px;
      transition: color .22s;
      user-select: none;
      flex: 0 0 25px;
    }
    body.dark .sep { color: #888; }
    .actions {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin: 32px auto 10px auto;
    }
    .btn {
      border-radius: var(--radius-md);
      padding: 13px 27px;
      font-size: 1.29rem;
      font-weight: 500;
      border: none;
      outline: none;
      cursor: pointer;
      box-shadow: 0 4px 18px var(--color-shadow);
      transition: background .18s, box-shadow .1s;
    }
    .btn-primary {
      background: var(--color-primary);
      color: #fff;
    }
    .btn-primary:hover, .btn-primary:focus { 
      background: #23b35f;
    }
    .btn-accent {
      background: var(--color-accent);
      color: #fff;
    }
    .btn-accent:hover, .btn-accent:focus {
      background: #f98718;
    }
    .history-section {
      max-width: 840px;
      margin:31px auto 16px auto;
      padding: 14px 10px;
      border-radius: var(--radius-md);
      background: var(--color-card-light);
      box-shadow: 0 1px 8px var(--color-shadow);
      transition: background .18s;
    }
    body.dark .history-section {
      background: var(--color-card-dark);
      border-color: #393d46;
    }
    .history-title {
      font-size: 1.04rem;
      font-weight: 500;
      color: #999;
      text-align: left;
      margin-bottom: 7px;
      transition: color .18s;
    }
    body.dark .history-title {
      color: #bccad8;
    }
    .history-list {
      list-style: none;
      padding-left: 0;
      margin: 0;
      width: 100%;
    }
    .history-list li {
      font-size: 1.12rem;
      margin-bottom: 7px;
      color: inherit;
      display: flex;
      flex-direction: row;
      align-items: center;
      flex-wrap: nowrap;
      gap:5px;
    }
    .history-list .sep {
      min-width:15px; width:15px; font-size:1em; color:#b5b5b5; margin:0 2px;
      background:none !important; box-shadow:none !important;
    }
    .history-list .history-result {
      color: var(--color-result);
      font-weight: 600;
      font-size:1.07em;
    }
    .help-btn {
      position: fixed;
      top: 19px; right: 16px;
      z-index: 20;
      background: var(--color-accent);
      width: 46px; height: 46px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 22px var(--color-shadow);
      border: none;
      transition: background .15s, box-shadow .15s;
      touch-action: manipulation;
    }
    .help-btn svg { width: 27px; height: 27px; fill: #fff; }
    .help-btn:hover, .help-btn:focus { background: #f98718; }
    .modal-bg {
      position:fixed;
      left:0; top:0;
      width:100vw;
      height:100vh;
      background: var(--color-bg-dark, rgba(0,0,0,0.4));
      display: flex;
      justify-content: center;
      align-items: center;
      z-index:99;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s;
    }
    .modal-bg.active {
      opacity:1;
      pointer-events: all;
    }
    .modal {
      background: var(--color-card-light);
      color: #263246;
      border-radius: var(--radius-lg);
      min-width: 240px;
      max-width: 400px;
      margin: 16px;
      padding: 19px 13px 17px 13px;
      box-shadow: 0 6px 40px rgba(0,0,0,0.18);
      animation: modalIn .22s;
      font-size:1.02rem;text-align:center;position:relative;
    }
    body.dark .modal {background: var(--color-card-dark);color: #ebeded;}
    @keyframes modalIn {from { opacity: 0; transform: translateY(16px) scale(.93);}to   { opacity: 1; transform: translateY(0) scale(1);}}
    .modal .close-btn {position:absolute;top:8px;right:14px;font-size:1.3rem;color:#888;transition:color .15s;}
    .modal .close-btn:hover {color:#333;}
    body.dark .modal .close-btn:hover {color:#fff;}

    /* -------- MOBILE VERTICAL "critical": proporzione TUTTA in verticale -------- */
    @media (max-width:460px){
      .proportion-row{
        display: flex;
        flex-direction: column;
        align-items:center;
        justify-content: center;
        gap: 0;
        margin-bottom:24px;
        width: 100%;
      }
      .block{
        min-width:110px;
        width:100%;
        margin:8px 0;
      }
      .sep{
        font-size:2.3rem;margin-bottom:-6px;margin-top:-12px;
        min-width:22px;width:22px;
        color:#b8b8b8;
      }
    }
  </style>
</head>
<body>
  <button class="help-btn" aria-label="Help" id="helpBtn">
    <svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="13" stroke-width="2.5" fill="none" stroke="#fff"/><circle cx="16" cy="16" r="6.2" stroke-width="2.2" fill="none" stroke="#fff"/><path stroke="#fff" stroke-width="2.1" fill="none" d="M8.6 8.6l2.7 2.7M22.7 8.6l-2.6 2.7M23.4 23.4l-2.8-2.8M8.6 23.4l2.7-2.7"/></svg>
  </button>
  <div class="container">
    <div class="title" id="title"></div>
    <form id="propForm" autocomplete="off">
      <div class="proportion-row">
        <div class="block">
          <div class="label" id="label1"></div>
          <input class="input-box" type="text" inputmode="text" maxlength="7" id="prop1" autocomplete="off" />
        </div>
        <span class="sep">:</span>
        <div class="block">
          <div class="label" id="label2"></div>
          <input class="input-box" type="text" inputmode="text" maxlength="7" id="prop2" autocomplete="off" />
        </div>
        <span class="sep">=</span>
        <div class="block">
          <div class="label" id="label3"></div>
          <input class="input-box" type="text" inputmode="text" maxlength="7" id="prop3" autocomplete="off" />
        </div>
        <span class="sep">:</span>
        <div class="block">
          <div class="label" id="label4"></div>
          <input class="input-box" type="text" inputmode="text" maxlength="7" id="prop4" autocomplete="off" />
        </div>
      </div>
      <div class="actions">
        <button type="submit" class="btn btn-primary" id="calcBtn"></button>
        <button type="button" class="btn btn-accent" style="display:none" id="resetBtn"></button>
      </div>
    </form>
    <section class="history-section" id="historySection" style="display:none">
      <div class="history-title" id="historyTitle"></div>
      <ul class="history-list" id="historyList"></ul>
    </section>
  </div>
  <div class="modal-bg" id="modalBg">
    <div class="modal" id="modalBox">
      <button class="close-btn" id="closeModalBtn" aria-label="Close">&times;</button>
      <div id="modalContent"></div>
    </div>
  </div>
  <script>
    const textIT = {
      title: "Calcolatore delle proporzioni",
      labels: ["Valore","Base","Valore","Base"],
      calcBtn: "Calcola!",
      resetBtn: "Reset",
      historyTitle: "Cronologia operazioni",
      modalHelp: `<b>Come usare il calcolatore delle proporzioni?</b><br><br>
      Scrivi tre valori numerici nei riquadri grandi e inserisci una sola incognita <b>x</b> (puoi usare anche X) nel riquadro dove vuoi calcolare il valore mancante.<br><br>
      Premi <b>Calcola!</b> per ottenere rapidamente il valore incognito.<br><br>
      Se c'è un errore negli input, il programma ti avvisa con un messaggio.<br><br>
      Dopo ogni operazione, trovi la cronologia in fondo alla pagina, dove il risultato calcolato è evidenziato in verde.<br><br>
      Premi <b>Reset</b> per azzerare la pagina.`,
      modalErrors: {
        oneX: "Devi inserire una sola incognita <b>x</b> in uno dei riquadri.<br>Gli altri devono contenere valori numerici.",
        fillAll: "Compila tutti i campi con valori numerici o la variabile <b>x</b>.",
        invNum: "Solo numeri validi o la variabile <b>x</b> sono ammessi nei riquadri.",
        div0: "Attenzione: non è possibile dividere per zero!",
      }
    };
    const textEN = {
      title: "Proportion Calculator",
      labels: ["Value","Base","Value","Base"],
      calcBtn: "Calculate!",
      resetBtn: "Reset",
      historyTitle: "History of operations",
      modalHelp: `<b>How to use the proportion calculator?</b><br><br>
      Enter three numeric values in the large boxes and put a single unknown <b>x</b> (you can use X too) in the box where you want to calculate the missing value.<br><br>
      Press <b>Calculate!</b> to quickly get the unknown.<br><br>
      If there's an error in your input, you'll see a warning message.<br><br>
      After each calculation you see your operations at the bottom, with the computed value highlighted in green.<br><br>
      Press <b>Reset</b> to clear the page.`,
      modalErrors: {
        oneX: "You must enter a single unknown <b>x</b> in one box.<br>The others must contain numeric values.",
        fillAll: "Fill all the fields with numbers or the variable <b>x</b>.",
        invNum: "Only valid numbers or the variable <b>x</b> are allowed in the boxes.",
        div0: "Warning: division by zero is not allowed!",
      }
    };
    function getLang(){
      try {
        let lang = navigator.language || navigator.userLanguage || "en";
        lang = lang.toLowerCase();
        return lang.startsWith("it") ? "it" : "en";
      } catch { return "en";}
    }
    const I18N = getLang() === "it" ? textIT : textEN;
    document.documentElement.lang = getLang();

    function setTheme() {
      const preferDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      if(preferDark) document.body.classList.add("dark"); else document.body.classList.remove("dark");
    }
    setTheme();
    window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", setTheme);

    function setUItexts() {
      document.getElementById("title").textContent = I18N.title;
      ["label1","label2","label3","label4"].forEach((id,i) => 
        document.getElementById(id).textContent = I18N.labels[i]);
      document.getElementById("calcBtn").textContent = I18N.calcBtn;
      document.getElementById("resetBtn").textContent = I18N.resetBtn;
      document.getElementById("historyTitle").textContent = I18N.historyTitle;
    }
    setUItexts();

    function updateInputWidth(e){
      const v = e.target.value;
      e.target.setAttribute("data-length", Math.max(1,v.length));
    }
    document.querySelectorAll('.input-box').forEach(inp => {
      inp.addEventListener("input", updateInputWidth);
      inp.setAttribute("data-length","1");
    });

    function showModal(html){
      document.getElementById("modalContent").innerHTML = html;
      document.getElementById("modalBg").classList.add("active");
    }
    document.getElementById("closeModalBtn").onclick = ()=>document.getElementById("modalBg").classList.remove("active");
    document.getElementById("modalBg").onclick = (e)=>{
      if(e.target === document.getElementById("modalBg")) document.getElementById("modalBg").classList.remove("active");
    };
    document.getElementById("helpBtn").onclick = ()=>showModal(I18N.modalHelp);

    const propIds = ['prop1','prop2','prop3','prop4'];
    let lastResultIdx = -1;
    let historyArr = [];
    function getInputs(){
      return propIds.map(id => document.getElementById(id).value.trim());
    }
    function setInputs(vals){
      propIds.forEach((id,i)=>document.getElementById(id).value=vals[i]);
      propIds.forEach(id=>updateInputWidth({target:document.getElementById(id)}));
    }
    function clearResultStyles(){
      propIds.forEach(id=>document.getElementById(id).classList.remove("result"));
    }
    function findXIndex(arr){
      return arr.findIndex(v=>/^x$/i.test(v));
    }
    function validateInputs(vals){
      const xIdx = findXIndex(vals);
      if(xIdx === -1 || vals.filter(v=>/^x$/i.test(v)).length > 1) return {ok:false,err:"oneX"};
      for(let i=0;i<4;i++){
        if(i!==xIdx){
          if(!/^(\d+(\.\d+)?|\.\d+)$/.test(vals[i])) return {ok:false,err:vals[i]===""?"fillAll":"invNum"};
        }
      }
      return {ok:true,xIdx};
    }
    function computeProportion(vals,xIdx){
      const nums = vals.map((v,i)=>i!==xIdx?parseFloat(v):null);
      let result = null;
      switch(xIdx){
        case 0: if(nums[3]===0) return {err:"div0"}; result = nums[1]*nums[2]/nums[3]; break;
        case 1: if(nums[2]===0) return {err:"div0"}; result = nums[0]*nums[3]/nums[2]; break;
        case 2: if(nums[1]===0) return {err:"div0"}; result = nums[0]*nums[3]/nums[1]; break;
        case 3: if(nums[0]===0) return {err:"div0"}; result = nums[1]*nums[2]/nums[0]; break;
        default: return {err:"oneX"};
      }
      return {result: +result.toFixed(6)};
    }
    function renderHistory(){
      const ul = document.getElementById("historyList");
      ul.innerHTML = "";
      historyArr.forEach(entry=>{
        let html =
           `<span>${entry.elems[0]}</span><span class="sep">:</span>`
         +`<span>${entry.elems[1]}</span><span class="sep">=</span>`
         +`<span${entry.xIdx===2?' class="history-result"':''}>${entry.elems[2]}</span><span class="sep">:</span>`
         +`<span${entry.xIdx===3?' class="history-result"':''}>${entry.elems[3]}</span>`;
        html = html.replace(`<span>${entry.elems[entry.xIdx]}</span>`, `<span class="history-result">${entry.elems[entry.xIdx]}</span>`);
        ul.innerHTML += `<li>${html}</li>`;
      });
      document.getElementById("historySection").style.display = historyArr.length ? "" : "none";
    }

    document.getElementById("propForm").onsubmit = function(e){
      e.preventDefault();
      clearResultStyles();
      const vals = getInputs();
      const valRes = validateInputs(vals);
      if(!valRes.ok){
        let msg = I18N.modalErrors[valRes.err]||"Errore";
        showModal(msg);
        return;
      }
      const comp = computeProportion(vals, valRes.xIdx);
      if(comp.err){
        showModal(I18N.modalErrors[comp.err]);
        return;
      }
      const resVal = comp.result.toString();
      vals[valRes.xIdx] = resVal;
      setInputs(vals);
      document.getElementById(propIds[valRes.xIdx]).classList.add("result");
      lastResultIdx = valRes.xIdx;
      historyArr.push({elems:vals.slice(),xIdx:valRes.xIdx});
      renderHistory();
      document.getElementById("resetBtn").style.display = "";
      document.getElementById("calcBtn").blur();
    };

    document.getElementById("resetBtn").onclick = function(){
      setInputs(["","","",""]);
      clearResultStyles();
      lastResultIdx = -1;
      document.getElementById("resetBtn").style.display = "none";
    };

    document.addEventListener("keydown",function(e){
      if(e.key==="Escape")document.getElementById("resetBtn").click();
    });
  </script>
</body>
</html>
